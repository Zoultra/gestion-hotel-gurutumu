<div class="container mt-4">
    <div class="row g-3">
  
    
<div class="col-md-6">
    <div class="card shadow-sm">
      
      <!-- Header principal -->
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Articles disponibles</h5>
      </div>
  
      <!-- Filtres (Affichage + Recherche) -->
      <div class="card-body pt-3 pb-0">
        <div class="row align-items-center mb-3">
          
          <!-- S√©lection du nombre d‚Äôarticles √† afficher -->
          <div class="col-md-6 d-flex align-items-center">
            <label class="me-2">Afficher</label>
            <select class="form-select form-select-sm w-auto" (change)="onTableSizeChange($event)">
              <option *ngFor="let size of tableSizes" [value]="size">{{ size }}</option>
            </select>
          </div>
  
          <!-- Champ de recherche -->
          <div class="col-md-6 d-flex align-items-center justify-content-end">
            <label class="me-2">Rechercher</label>
            <input type="search" [(ngModel)]="myFilterText" class="form-control form-control-sm w-75" placeholder="Nom de l'article" />
          </div>
        </div>
      </div>
  
 

        <!-- Liste des articles -->
      <div class="card-body pt-0">
        <div *ngFor="let article of articles | filter: myFilterText | paginate: {
              itemsPerPage: tableSize,
              currentPage: page,
              totalItems: count
            }; let i = index"
             class="d-flex justify-content-between align-items-center border-bottom py-2">
          <div>
            <strong>{{ article.designation }}</strong><br />
            <small>{{ article.prixUnitaire }} FCFA</small>
          </div>
          <button class="btn btn-sm btn-outline-success" (click)="ajouterArticle(article)">
            <i class="fa fa-plus"></i> Ajouter
          </button>
        </div>
      </div>

      <!-- Liste des articles 
      
      <div class="row">
  <div *ngFor="let article of articles | filter: myFilterText | paginate: {
            itemsPerPage: tableSize,
            currentPage: page,
            totalItems: count
          }; let i = index"
       class="col-md-4 mb-4">
    <div (click)="ajouterArticle(article)" class="card h-80 m-1">
      <img   [src]=" apiURL + article.imagePath" 
           class="card-img-top p-1" 
           alt="Image de l'article"
           style="height: 180px; width: 100; object-fit: contain;">
      <div class="card-body d-flex flex-column">
        <h6 class="card-title">{{ article.designation }}</h6>
        <p class="card-text text-primary font-weight-bold">{{ article.prixUnitaire }} FCFA</p>
        <button class="btn btn-success mt-auto align-self-start" 
                (click)="ajouterArticle(article)">
          <i class="fa fa-plus"></i>
        </button>
      </div>
    </div>
  </div>
</div>
  -->
      <!-- Pagination -->
      <div class="card-footer bg-white border-top-0">
        <pagination-controls 
          class="d-flex justify-content-end"
          previousLabel="Pr√©c√©dent"
          nextLabel="Suivant"
          (pageChange)="onTableDataChange($event)">
        </pagination-controls>
      </div>
  
    </div>
  </div>
  
  
      <!-- üü© Carte 2 : Formulaire de vente -->
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">Vente en cours</h5>
          </div>
          <div class="card-body">
  
            <!-- Client -->
            <div class="mb-3">
              <label for="client" class="form-label">Liste des articles</label>
                
            </div>
  
            <!-- Liste des articles ajout√©s -->
            
            <div *ngFor="let ligne of vente.lignes; let i = index" class="row align-items-center mb-2 border border-secondary rounded p-2">
                <div class="col-md-3"> 
                  <strong>{{ ligne.article.designation }}</strong>
                </div>
                <div class="col-md-2">
                  <input type="number" class="form-control" [(ngModel)]="ligne.quantite" (ngModelChange)="calculerMontantTotal()" min="1" />
                </div>
                <div class="col-md-3"> 
                  <input type="number" class="form-control" [(ngModel)]="ligne.prixUnitaire" (ngModelChange)="calculerMontantTotal()" min="0" readonly />
                </div>
                <div class="col-md-2 text-end">
                  {{ ligne.quantite * ligne.prixUnitaire | number:'1.0-0' }} FCFA
                </div>
                <div class="col-md-2 text-end">
                <button class="btn btn-sm btn-outline-danger" (click)="retirerArticle(ligne)">
                    <i class="fa fa-trash"></i>
                </button>
                </div>
              </div>

  
            <!-- Total -->
            <div class="mt-3 text-end">
              <strong>Total : {{ vente.montantTotal }} FCFA</strong>
            </div>

         <div class="row mt-3">
                     
     <div class="col-md-4">
  <label class="form-label">Table</label>
  <select class="form-select" [(ngModel)]="vente.tableResto" >
    <option value="">S√©lectionnez</option>
    <option *ngFor="let i of [].constructor(20); let idx = index" [value]="'TABLE ' + (idx + 1)">
      TABLE {{ idx + 1 }}
    </option>
     <option  [value]="'AUTRE'">
      AUTRE
    </option>
  </select>
</div>


  <!-- Montant donn√© par le client -->
  <div class="col-md-4">
    <label for="montantDonne" class="form-label">Montant Pay√©</label>
    <input type="number" id="montantDonne" class="form-control"
           [(ngModel)]="vente.montantPaye"
           (input)="calculerMonnaie()"
           placeholder="Ex: 10000" />
  </div>

  <!-- Monnaie √† rendre -->
  <div class="col-md-4">
    <label class="form-label">Monnaie √† rendre</label>
    <input type="text"  [(ngModel)]="vente.monnaie" class="form-control" [value]="vente.monnaie + ' FCFA'" readonly />
  </div>
</div>
  
            <!-- Bouton de validation -->
    <div class="row mt-3">
            <div class="col-md-3 d-flex align-items-end">
              <button type="button" class="btn btn-outline-secondary w-100" (click)="calculerMonnaie()">
                Calculer
              </button>
            </div>


            <div class="text-end mt-3">
              <button class="btn btn-success" (click)="validerVente()">
                <i class="fa fa-check"></i> Valider la vente
              </button>
            </div>
  </div>
          </div>
        </div>
      </div>
  
    </div>

    <div class="row m-3">
       <div class="col-md-12">
           <div class="card shadow-sm">
              <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Historique des ventes r√©centes </h5>
             </div>
              <div class="card-body">
                    <div class="mt-4">
      
      
                       <table class="table table-striped table-bordered table-sm row-border hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Table</th>
                    <th>Date Vente</th>
                    <th>Montant Total</th>
                     <th>Statut</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <ng-container *ngFor="let vente of last50Ventes | filter: myFilterText | paginate: {
                    itemsPerPage: tableSize,
                    currentPage: page,
                    totalItems: 20
                  }; let i = index">
                    <!-- Ligne principale -->
                    <tr>
                        <td>{{ vente.id }}</td>
                        <td>{{ vente.tableResto }}</td>
                        <td>{{ vente.dateVente | date:'dd/MM/yyyy' }}</td>
                        <td>{{ vente.montantTotal | number:'1.2-2' }} FCFA</td>
                        <td [ngClass]="{
                            'bg-success text-white fw-bold': vente.etatVente === 'PAYEE',
                            'bg-danger text-white fw-bold': vente.etatVente === 'NON_PAYEE'
                                       }">
                                         {{ vente.etatVente }}
                        </td>
                        <td>
                            <button (click)="toggleDetails(vente)" class="btn btn-sm" 
                                    [ngClass]="{'btn-info': !vente.showDetails, 'btn-secondary': vente.showDetails}">
                                <i class="fa fa-{{ vente.showDetails ? 'minus' : 'plus' }} me-1"></i>
                                {{ vente.showDetails ? 'Masquer' : 'D√©tails' }}
                            </button>
                            <button (click)="updateVente(vente.id)" class="btn btn-warning btn-sm ms-2">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button *ngIf="role === 'ADMIN'" (click)="deleteVente(vente.id)" class="btn btn-danger btn-sm ms-2">
                                <i class="fa fa-trash"></i>
                            </button>

                            <button (click)="generateTicket(vente)" class="btn btn-success btn-sm ms-2" >
                                           <i class="fa fa-print"></i>   Imprimer
                             </button>
                              <button *ngIf="vente.etatVente === 'NON_PAYEE'" 
                                     (click)="confirmerPaiement(vente)" 
                                     class="btn btn-success btn-sm ms-2">
                                   <i class="fa fa-check"></i> Payer
                              </button>

                        </td>
                    </tr>

                    <!-- Ligne des d√©tails - s'affiche directement sous la ligne principale -->
                    <tr [class.d-none]="!vente.showDetails">
                        <td colspan="5" class="p-0">
                            <div class="details-container" [class.show]="vente.showDetails">
                                <h6 class="px-3 pt-3 mb-3 fw-bold">D√©tails des articles vendus</h6>
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th width="40%">Article</th>
                                            <th width="15%">Prix Unitaire</th>
                                            <th width="15%">Quantit√©</th>
                                            <th width="15%">Total</th>
                                           
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let ligne of vente.ligneVentes">
                                            <td>{{ligne.article?.designation || 'N/A'}}</td>
                                            <td>{{ligne.prixUnitaire | number:'1.2-2'}} FCFA</td>
                                            <td>{{ligne.quantite}}</td>
                                            <td>{{(ligne.prixUnitaire * ligne.quantite) | number:'1.2-2'}} FCFA</td>
                                            
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                </ng-container>
            </tbody>
        </table>


                      
                    </div>
              </div>
          </div>
        </div>
    </div>
  </div>
  